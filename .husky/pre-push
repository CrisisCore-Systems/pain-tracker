#!/bin/bash
# Pre-push hook: ensure dynamic badges are up to date on main branch.
# Skips on non-main branches, CI, or when badges are already in the push.

BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
if [ "$BRANCH" != "main" ]; then
  echo "[pre-push] Not on main (current: $BRANCH) - skipping badge generation." >&2
  exit 0
fi

if [ -n "${CI:-}" ]; then
  echo "[pre-push] Running in CI - skip." >&2
  exit 0
fi

if ! command -v npm >/dev/null 2>&1; then
  echo "[pre-push] npm not available - skipping." >&2
  exit 0
fi

# If badge files were already committed in the push, trust them and skip
# regeneration. This avoids it re-running badge:all (which re-runs tests),
# getting slightly different numbers, and blocking the push in a loop.
BADGES_IN_PUSH=$(git diff --name-only origin/main..HEAD -- badges/*.json 2>/dev/null || true)
if [ -n "$BADGES_IN_PUSH" ]; then
  echo "[pre-push] Badge files already updated in this push - skipping regeneration." >&2
  exit 0
fi

echo "[pre-push] Generating dynamic badges..." >&2
npm run -s badge:all || echo "[pre-push] badge:all failed (continuing, will not block push)." >&2

# IMPORTANT: pre-push hooks must never create commits.
# If badge JSONs changed, block the push and ask the developer to commit explicitly.
BADGE_CHANGES=$(git status --porcelain -- badges/*.json 2>/dev/null || true)
if [ -n "$BADGE_CHANGES" ]; then
  echo "[pre-push] Badge JSONs changed. This hook will not auto-commit." >&2
  echo "[pre-push] Please review and commit them, then push again:" >&2
  echo "  git add badges/*.json" >&2
  echo "  git commit -m \"chore(badges): update dynamic badges\"" >&2
  exit 1
fi

echo "[pre-push] No badge changes detected." >&2

exit 0

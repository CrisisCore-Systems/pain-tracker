#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"
set -e

echo "ğŸ” Running pre-commit checks..."

# CrisisCore safety gate
echo "ğŸ›¡ï¸  Checking for security vulnerabilities..."
node scripts/check-collapse-vectors.js || { 
  echo "âŒ CRISIS: collapse vectors detected"; 
  exit 1; 
}

# Type checking
echo "ğŸ“ Running TypeScript type checking..."
npm run typecheck || {
  echo "âŒ TypeScript type checking failed"
  echo "ğŸ’¡ Fix type errors before committing"
  exit 1
}

# Linting
echo "ğŸ” Running ESLint..."
npm run lint || {
  echo "âŒ ESLint checks failed"
  echo "ğŸ’¡ Run 'npm run lint' to see issues and fix them"
  exit 1
}

# Build verification  
echo "ğŸ—ï¸  Verifying build integrity..."
VITE_APP_ENVIRONMENT=development VITE_WCB_API_ENDPOINT=/api/wcb npm run build || {
  echo "âŒ Build verification failed"
  echo "ğŸ’¡ Fix build errors before committing"
  exit 1
}

# Security checks for hardcoded secrets
echo "ğŸ” Scanning for hardcoded secrets..."
if grep -r --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
  -E "(api[_-]?key|secret|password|token).*=.*['\"][^'\"]{8,}" src/ ; then
  echo "âŒ Potential hardcoded secrets detected!"
  echo "ğŸ’¡ Use environment variables instead of hardcoded secrets"
  exit 1
fi

# Check for Sentry DSN hardcoding
if grep -r --include="*.ts" --include="*.tsx" \
  "https://.*@.*\.ingest\..*\.sentry\.io" src/ ; then
  echo "âŒ Hardcoded Sentry DSN detected!"
  echo "ğŸ’¡ Use VITE_SENTRY_DSN environment variable instead"
  exit 1
fi

echo "âœ… All pre-commit checks passed!"

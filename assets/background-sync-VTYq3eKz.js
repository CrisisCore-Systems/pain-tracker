import{offlineStorage as t}from"./offline-storage-BNc7x0M7.js";import{s as e}from"./index-BcPkEvkq.js";import"./react-vendor-CM2d6bHp.js";import"./chart-vendor-C6dKBweC.js";import"./state-vendor-gOFTyJpA.js";import"./pdf-vendor-zZbfvrDE.js";import"./icons-vendor-DZ-9b690.js";import"./date-vendor-Bi3xipBn.js";import"./i18n-vendor-C-xkjauL.js";class n{static instance;isOnline=navigator.onLine;syncInProgress=!1;retryTimeouts=new Map;maxRetries=3;retryDelays=[1e3,5e3,15e3];constructor(){this.setupEventListeners(),this.startPeriodicSync()}static getInstance(){return n.instance||(n.instance=new n),n.instance}setupEventListeners(){window.addEventListener("online",()=>{this.isOnline=!0,this.syncAllPendingData()}),window.addEventListener("offline",()=>{this.isOnline=!1}),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&this.isOnline&&this.syncAllPendingData()}),window.addEventListener("pwa-online",()=>{this.isOnline=!0,this.syncAllPendingData()})}startPeriodicSync(){setInterval(()=>{this.isOnline&&!this.syncInProgress&&this.syncAllPendingData()},3e5)}async queueForSync(n,s,r,i="medium"){try{const a={"Content-Type":"application/json"},c=e.get("auth-token",{encrypt:!0});c&&(a.Authorization=`Bearer ${c}`),await t.addToSyncQueue({url:n,method:s.toUpperCase(),headers:a,body:r?JSON.stringify(r):void 0,priority:i,type:"api-request"}),this.isOnline&&this.syncAllPendingData()}catch(a){throw a}}async syncAllPendingData(){if(this.syncInProgress)return this.getEmptyStats();if(!this.isOnline)return this.getEmptyStats();this.syncInProgress=!0;const e={totalItems:0,successCount:0,failureCount:0,skippedCount:0,errors:[]};try{const s=await t.getSyncQueue();if(e.totalItems=s.length,0===s.length)return e;for(const r of s)try{const n=await this.syncItem(r);n.success?(e.successCount++,await t.removeSyncQueueItem(r.id)):n.error&&((r.retryCount||0)>=this.maxRetries?(e.failureCount++,e.errors.push(`Max retries exceeded for ${r.url}: ${n.error}`),await t.removeSyncQueueItem(r.id)):(await this.scheduleRetry(r,n),e.skippedCount++))}catch(n){e.failureCount++,e.errors.push(`Sync error for ${r.url}: ${n}`)}e.successCount>0&&await this.updateLocalStore(),this.dispatchSyncEvent("sync-completed",e)}catch(n){const t=n instanceof Error?n.message:String(n);e.errors.push(`Sync process failed: ${t}`),this.dispatchSyncEvent("sync-error",{error:t})}finally{this.syncInProgress=!1}return e}async syncItem(t){try{if(!this.isOnline)return{success:!1,itemId:t.id,error:"Offline"};const e=await fetch(t.url,{method:t.method,headers:t.headers,body:t.body});if(e.ok)return{success:!0,itemId:t.id};{let n=`HTTP ${e.status}`;try{n=(await e.json()).message||n}catch{n=e.statusText||n}const s=e.status>=500||429===e.status;return{success:!1,itemId:t.id,error:n,retryAfter:s?this.getRetryDelay(t.retryCount||0):void 0}}}catch(e){return{success:!1,itemId:t.id,error:e instanceof Error?e.message:"Network error"}}}async scheduleRetry(e,n){const s=n.retryAfter||this.getRetryDelay(e.retryCount||0);this.retryTimeouts.has(e.id)&&clearTimeout(this.retryTimeouts.get(e.id)),await t.updateSyncQueueItem(e.id,{retryCount:(e.retryCount||0)+1});const r=setTimeout(()=>{this.retryTimeouts.delete(e.id),this.syncAllPendingData()},s);this.retryTimeouts.set(e.id,r)}getRetryDelay(t){return t<this.retryDelays.length?this.retryDelays[t]:Math.min(3e4,this.retryDelays[this.retryDelays.length-1]*Math.pow(2,t-this.retryDelays.length))}async updateLocalStore(){try{const e=await t.getUnsyncedData();for(const t of e)"pain-entry"===t.type&&t.synced}catch(e){}}getEmptyStats(){return{totalItems:0,successCount:0,failureCount:0,skippedCount:0,errors:[]}}dispatchSyncEvent(t,e){const n=new CustomEvent(`background-sync-${t}`,{detail:e});window.dispatchEvent(n)}async forcSync(){return this.syncAllPendingData()}async forceSync(){return this.forcSync()}async clearFailedItems(){try{const e=(await t.getSyncQueue()).filter(t=>(t.retryCount||0)>=this.maxRetries);await Promise.all(e.map(e=>t.removeSyncQueueItem(e.id)))}catch(e){}}async getPendingItemsCount(){try{return(await t.getSyncQueue()).length}catch(e){return 0}}getSyncStatus(){return{isOnline:this.isOnline,isSyncing:this.syncInProgress}}async emergencySync(t,n){if(!this.isOnline)return await this.queueForSync(n,"POST",t,"high"),!1;try{return!!(await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.get("auth-token",{encrypt:!0})||""}`},body:JSON.stringify(t)})).ok||(await this.queueForSync(n,"POST",t,"high"),!1)}catch(s){return await this.queueForSync(n,"POST",t,"high"),!1}}}class s{backgroundSync;baseUrl;constructor(){this.backgroundSync=n.getInstance(),this.baseUrl="/api"}async syncPainEntry(t){const e=`${this.baseUrl}/pain-entries`;await this.backgroundSync.queueForSync(e,"POST",t,"high")}async syncPainEntryUpdate(t,e){const n=`${this.baseUrl}/pain-entries/${t}`;await this.backgroundSync.queueForSync(n,"PUT",e,"medium")}async syncEmergencyData(t){const e=`${this.baseUrl}/emergency`;return this.backgroundSync.emergencySync(t,e)}async syncActivityLog(t){const e=`${this.baseUrl}/activity-logs`;await this.backgroundSync.queueForSync(e,"POST",t,"low")}async syncSettings(t){const e=`${this.baseUrl}/settings`;await this.backgroundSync.queueForSync(e,"PUT",t,"low")}async getSyncStatus(){const n=(await t.getSyncQueue()).filter(t=>t.url.includes("/pain-entries")),s=e.get("last-sync-time"),{isOnline:r,isSyncing:i}=this.backgroundSync.getSyncStatus();return{pendingEntries:n.length,lastSync:s,isOnline:r,isSyncing:i}}async forceSync(){(await this.backgroundSync.forceSync()).successCount>0&&e.set("last-sync-time",(new Date).toISOString())}}const r=n.getInstance(),i=new s;export{n as BackgroundSyncService,s as PainTrackerSync,r as backgroundSync,i as painTrackerSync};
